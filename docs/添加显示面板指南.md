# 添加“显示面板”（DOM 注入）新手指南

这篇文档解决一个最常见的痛点：**小白不知道怎么把“一个面板/按钮/信息显示区”加到酒馆页面里**。

你将学会一套稳定流程：

- **F12 找到目标元素（挂载点）**
- **复制 selector / outerHTML**
- **先在 Console 验证选择器**
- **把面板用 JS 注入进去，并且防止重复注入**

> 说明：本文以“主界面任意位置注入”为主（例如在发送按钮旁边、顶部栏、聊天区旁边等）。  
> 如果你只是想做“扩展设置里的折叠面板”，也提供了更稳的替代方案，见文末。

---

## 你要准备什么

一个最小扩展通常是这样（不涉及打包编译）：

```text
my-plugin/
├── manifest.json
├── index.js
└── style.css   (可选)
```

`manifest.json` 里只要指向你的 `index.js` 即可（示例仅供理解）：

```json
{
  "display_name": "My Panel Demo",
  "loading_order": 10,
  "js": "index.js",
  "css": "style.css",
  "author": "you",
  "version": "0.1.0"
}
```

**强烈建议你先定两样东西：**

- **面板根元素 ID**：例如 `my-panel-demo`（必须唯一，用来“防重复注入”）
- **挂载点选择器**：例如 `#send_but`（你希望把面板放在哪里旁边/里面）

---

## 步骤 1：F12 找到“挂载点”（你要把面板插到哪里）

1. 在酒馆页面里，对着你想放面板的位置附近 **右键 → 检查（Inspect）**（或按 `F12`）。
2. 在 **Elements** 面板里，选中那块区域对应的 HTML。
3. 优先寻找 **稳定特征**：
   - 最优：`id="..."`（通常最稳定）
   - 其次：稳定的 `class="..."`（但别用太通用的）

常见“地标”例子（通常比较稳定）：

- `#send_but`：发送按钮
- `#user_input`：输入框
- `#chat`：聊天记录容器
- `#top-bar`：顶部栏
- `#left-drawer`：左侧抽屉栏

---

## 步骤 2：复制你需要的信息（selector / outerHTML 的用途不同）

在 Elements 面板里对目标元素右键：

- **Copy → Copy selector**
  - 用途：得到一个 CSS 选择器，拿来写 `$(selector)` / `document.querySelector(selector)`。
  - 注意：如果复制出来很长、带很多 `:nth-child(...)`，**它很脆**，换个主题/版本可能就失效。

- **Copy → Copy outerHTML**
  - 用途：参考酒馆原生结构和 class（让你做出来的面板更像原生）。
  - 你一般不会把整段 outerHTML 原封不动注入；更多是“抄结构/抄类名”，再换成自己的内容。

---

## 步骤 3：先在 Console 里验证“找得到”

在 Console 输入（两种写法任选其一）：

```js
document.querySelector("#send_but")
```

或（酒馆页面一般有 jQuery）：

```js
$("#send_but").length
```

你希望看到的结果：

- `document.querySelector(...)` 返回一个元素（不是 `null`）
- `$("#...").length` 返回 `1`（至少大于 `0`）

如果这里都找不到，那你后面写扩展也一定找不到——先换一个更稳定的 selector。

---

## 步骤 4：最小可运行注入模板（可直接照抄）

把下面这段放进你的扩展 `index.js`。然后刷新酒馆页面，按 F12 看 Console 日志，并观察页面是否出现面板。

```js
(function () {
  const MODULE_NAME = "MyPanelDemo";

  // 1) 给你的面板一个唯一 ID：用于防重复
  const PANEL_ID = "my-panel-demo";

  // 2) 选择你要挂载到哪个元素旁边/里面（先在 Console 验证它找得到）
  const ANCHOR_SELECTOR = "#send_but";

  // 3) 从酒馆拿 context（用于 APP_READY 等事件）
  const ctx = SillyTavern.getContext();
  const { eventSource, event_types } = ctx;

  function mountPanel() {
    // 防重复：如果面板已存在，就直接退出
    if (document.getElementById(PANEL_ID)) return;

    const $anchor = $(ANCHOR_SELECTOR);
    if ($anchor.length === 0) {
      console.warn(`[${MODULE_NAME}] 找不到挂载点：`, ANCHOR_SELECTOR);
      return;
    }

    const html = `
      <div id="${PANEL_ID}" class="my-panel-demo">
        <div class="my-panel-demo__row">
          <b>我的显示面板</b>
          <button id="${PANEL_ID}__btn" class="menu_button">点我</button>
        </div>
        <div id="${PANEL_ID}__text" class="my-panel-demo__row"></div>
      </div>
    `;

    // 你可以换成：append / prepend / before / after
    // - after：放在挂载点后面（同级）
    // - append：放在挂载点内部最后面
    $anchor.after(html);

    // 绑定事件（面板只会注入一次，所以这样绑不会重复）
    $(`#${PANEL_ID}__btn`).on("click", () => {
      toastr.info("按钮点击成功");
      $(`#${PANEL_ID}__text`).text(`当前时间：${new Date().toLocaleString()}`);
    });

    console.log(`[${MODULE_NAME}] 面板已注入：`, `#${PANEL_ID}`);
  }

  // 规范：等 APP_READY 再动 DOM
  eventSource.on(event_types.APP_READY, () => {
    try {
      mountPanel();
    } catch (err) {
      console.error(`[${MODULE_NAME}] mountPanel 失败：`, err);
    }
  });
})();
```

### 我应该用 append/before/after 还是 prepend？

- **`$(target).append(html)`**：加在目标内部最后面（适合“塞进一个容器里”）
- **`$(target).prepend(html)`**：加在目标内部最前面
- **`$(target).before(html)`**：加在目标前面（同级）
- **`$(target).after(html)`**：加在目标后面（同级）

> 小技巧：如果你要“贴着某个按钮旁边放一个小面板/小按钮”，通常 `after/before` 更直观。

---

## 步骤 5：让它别那么丑（样式与主题适配）

### 方案 A：放到 `style.css`（推荐）

在你的扩展 `style.css` 里加（示例）：

```css
.my-panel-demo {
  margin: 8px 0;
  padding: 8px;
  border: 1px solid var(--mainColor);
  border-radius: 8px;
}

.my-panel-demo__row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 4px 0;
}
```

关键点：

- **别硬编码颜色**：尽量用 `var(--mainColor)` 等 CSS 变量（主题会跟着变）
- **优先复用原生类名**：比如按钮用 `menu_button`，输入框用 `text_pole`

### 方案 B：做悬浮 HUD（右下角小面板）

把模板里的根元素加上固定定位（两种做法任选）：

1) 用 CSS（推荐）：

```css
.my-panel-demo {
  position: fixed;
  right: 16px;
  bottom: 16px;
  z-index: 9999;
  background: var(--SmartThemeBlurTintColor, rgba(0, 0, 0, 0.35));
  backdrop-filter: blur(8px);
}
```

2) 或者直接在 HTML 上写 `style="..."`（不推荐，但小白容易上手）。

---

## 进阶：页面刷新/切换聊天后，确保面板还在

有些区域可能会在切换聊天/重新渲染时被替换掉。最简单的做法是：把“挂载”写成 `ensureMounted()`，在多个事件里都调用一次（依然靠 `PANEL_ID` 防重复）。

```js
const ctx = SillyTavern.getContext();
const { eventSource, event_types } = ctx;

function ensureMounted() {
  // 内部依然用 document.getElementById(PANEL_ID) 防重复
}

eventSource.on(event_types.APP_READY, ensureMounted);
eventSource.on(event_types.CHAT_CHANGED, ensureMounted);
```

---

## 给 AI 的“提问模板”（复制后填空即可）

当你想让 AI 帮你把某个面板注入到页面时，把下面模板发给 AI（连同你的 selector 一起）：

```text
我要在 SillyTavern 页面里注入一个“显示面板”，请用 JS + jQuery 实现。

要求：
1) 必须在 eventSource.on(event_types.APP_READY, ...) 后执行
2) 挂载点 selector：<在这里粘贴 Copy selector 或你手写的稳定 selector>
3) 注入方式：after / before / append / prepend（我希望：<描述位置>）
4) 面板根元素 ID：<唯一 id，例如 my-plugin-panel>
5) 必须防重复注入：如果 #<面板id> 已存在就 return
6) 面板内容：<要显示什么？比如“当前时间/角色名/计数器/按钮”>
7) 交互：<按钮点击做什么？是否需要 toast？>
8) 是否需要悬浮：是/否（如果是：右下角 fixed + z-index 9999）
9) 主题适配：不要硬编码颜色，尽量用 var(--mainColor) 等 CSS 变量
```

---

## 常见问题排查（速查）

### 1) “没显示/找不到元素”

- 先在 Console 验证：`$(ANCHOR_SELECTOR).length` 是否大于 0
- selector 太长太脆：优先换成稳定 ID（例如 `#chat`、`#send_but`）
- 你没等 `APP_READY`：把注入逻辑放到 `eventSource.on(event_types.APP_READY, ...)` 里

### 2) “出现两份/越刷新越多”

- 你缺少防重复：一定要有 `if (document.getElementById(PANEL_ID)) return;`
- 你重复绑定事件：确保事件绑定发生在“注入成功之后”，并且注入只执行一次

### 3) “面板被挡住/点不到”

- 悬浮面板要高 `z-index`（例如 9999）
- 看父容器有没有 `overflow: hidden`，会把你加的东西裁掉（必要时改为 `after` 插在外层）

### 4) “样式跟主题不搭”

- 不要硬编码颜色
- 尽量复用酒馆原生类名（例如按钮 `menu_button`）

---

## 更稳的替代方案：如果你其实是在做“扩展设置面板”

如果你的真实需求是：**把面板加到“扩展设置”里**，那你不一定需要自己找 `#extensions_settings` 并手动拼折叠结构。

在本仓库的 `st-api-wrapper` 里，有更稳的 API：`ui.registerSettingsPanel`（会帮你处理 `APP_READY`、挂载点查找、折叠逻辑等）。

前提：

- 你项目里已经加载了 `st-api-wrapper`，并且页面上存在全局对象 `window.ST_API`

最小示例（只展示用法，细节以文档为准）：

```js
await window.ST_API.ui.registerSettingsPanel({
  id: "my-plugin.settings",
  title: "我的插件设置",
  target: "right",
  content: {
    kind: "html",
    html: "<p>这里是设置内容</p>"
  }
});
```

参考文档：

- `st-api-wrapper/docs/ui/registerSettingsPanel.md`

